<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin – Products</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>
  <body class="p-4">
    <div class="main-container">
      <div class="header mb-4">
        <h1 class="mb-3">Admin – Products</h1>

        <div class="form-input-key g-2 mb-3">
          <div class="item">
            <input
              id="adminKey"
              class="input-key form-control"
              placeholder="Masukkan ADMIN_KEY"
            />
          </div>
          <div class="item-button d-flex gap-2">
            <button id="btnLoad" class="btn btn-secondary">Load</button>
            <button id="btnAdd" class="btn btn-primary">Add Product</button>
            <button id="btnSave" class="btn btn-success">Save</button>
          </div>
        </div>
        <div class="content-products">
          <pre id="status" class="p-2 bg-light border mb-3">Ready.</pre>
          <div id="editor"></div>
        </div>
      </div>
    </div>

    <script>
      let state = {
        version: 1,
        updatedAt: new Date().toISOString(),
        products: [],
      };
      const el = (s) => document.querySelector(s);
      const editor = el("#editor");
      const status = el("#status");

      const render = () => {
        editor.innerHTML = "";
        state.products.forEach((p, i) => {
          const wrap = document.createElement("div");
          wrap.className = "card p-3 mb-3";
          wrap.innerHTML = `
            <div class="row g-2">
              <div class="col-md-3">
                <input class="form-control" value="${
                  p.id || ""
                }" placeholder="id unik" data-k="id" data-i="${i}">
              </div>
              <div class="col-md-4">
                <input class="form-control" value="${
                  p.title || ""
                }" placeholder="title" data-k="title" data-i="${i}">
              </div>
              <div class="col-md-5 d-flex gap-2">
                <input class="form-control" value="${
                  p.logo || ""
                }" placeholder="logo URL" data-k="logo" data-i="${i}">
              </div>

              <!-- Upload logo UI -->
              <div class="col-md-12 d-flex align-items-center gap-2 mt-2">
                <input type="file" accept=".png,.jpg,.jpeg,.svg" class="form-control" data-act="pick-logo" data-i="${i}" style="max-width:420px;">
                <button class="btn btn-outline-dark" data-act="upload-logo" data-i="${i}">Upload logo</button>
                <small class="text-muted">Max 2MB • .svg .png .jpg</small>
              </div>
            </div>

            <div class="mt-3">
              <h6 class="mb-2">Packages</h6>
              <div>
                ${(p.packages || [])
                  .map(
                    (pkg, j) => `
                  <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-8">
                      <input class="form-control" value="${
                        pkg.name || ""
                      }" placeholder="name" data-k="pkg-name" data-i="${i}" data-j="${j}">
                    </div>
                    <div class="col-md-3">
                      <input type="number" class="form-control" value="${
                        pkg.price || 0
                      }" placeholder="price" data-k="pkg-price" data-i="${i}" data-j="${j}">
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-outline-danger" data-act="del-pkg" data-i="${i}" data-j="${j}">×</button>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
              <button class="btn btn-sm btn-outline-primary" data-act="add-pkg" data-i="${i}">+ Add package</button>
            </div>

            <div class="mt-2 d-flex justify-content-between">
              <button class="btn btn-sm btn-outline-danger" data-act="del" data-i="${i}">Delete product</button>
              <small class="text-muted">Preview logo: <code>${
                p.logo || ""
              }</code></small>
            </div>
          `;
          editor.appendChild(wrap);
        });
      };

      editor.addEventListener("input", (e) => {
        const i = +e.target.dataset.i;
        const j = e.target.dataset.j ? +e.target.dataset.j : null;
        const k = e.target.dataset.k;
        const v = e.target.value;
        if (k === "pkg-name") state.products[i].packages[j].name = v;
        else if (k === "pkg-price")
          state.products[i].packages[j].price = Number(v || 0);
        else state.products[i][k] = v;
        state.updatedAt = new Date().toISOString();
      });

      editor.addEventListener("click", (e) => {
        const act = e.target.dataset.act;
        if (!act) return;
        const i = +e.target.dataset.i;
        if (act === "add-pkg") {
          (state.products[i].packages ||= []).push({
            name: "New Package",
            price: 0,
          });
          render();
        }
        if (act === "del-pkg") {
          const j = +e.target.dataset.j;
          state.products[i].packages.splice(j, 1);
          render();
        }
        if (act === "del") {
          state.products.splice(i, 1);
          render();
        }
      });

      el("#btnAdd").onclick = () => {
        state.products.push({
          id: "new-id",
          title: "New Product",
          logo: "",
          periodLabelLeft: "PAKET",
          periodLabelRight: "1 BULAN",
          packages: [],
        });
        render();
      };

      el("#btnLoad").onclick = async () => {
        status.textContent = "Loading...";
        const res = await fetch("/api/products", {
          headers: { "x-admin-key": el("#adminKey").value || "" },
        });
        const json = await res.json();
        if (res.ok) {
          state = json;
          render();
          status.textContent = "Loaded ✓";
        } else {
          status.textContent = "Error: " + (json.message || res.statusText);
        }
      };

      el("#btnSave").onclick = async () => {
        status.textContent = "Saving...";
        const res = await fetch("/api/products", {
          method: "PUT",
          headers: {
            "content-type": "application/json",
            "x-admin-key": el("#adminKey").value || "",
          },
          body: JSON.stringify(state),
        });
        const json = await res.json();
        if (res.ok)
          status.textContent =
            "Saved ✓ (commit: " + (json.commitSha || "").slice(0, 7) + ")";
        else status.textContent = "Error: " + (json.message || res.statusText);
      };
    </script>

    <script>
      // helper file ke base64 tanpa prefix data
      const toBase64 = (file) =>
        new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => {
            const result = String(r.result || "");
            if (!result.startsWith("data:"))
              return reject(new Error("Invalid data URL"));
            const comma = result.indexOf(",");
            const header = result.slice(0, comma);
            const payload = result.slice(comma + 1);
            if (header.includes(";base64")) return resolve(payload);
            try {
              const raw = decodeURIComponent(payload);
              const b64 = btoa(raw);
              resolve(b64);
            } catch {
              reject(new Error("Failed to convert to base64"));
            }
          };
          r.onerror = reject;
          r.readAsDataURL(file);
        });

      const pickedFiles = {};

      editor.addEventListener("change", (e) => {
        if (e.target.dataset.act === "pick-logo") {
          const i = +e.target.dataset.i;
          const f = e.target.files?.[0];
          if (!f) return;
          pickedFiles[i] = f;
          status.textContent = `Selected: ${f.name}`;
          // tidak lagi memprefill path assets lokal
        }
      });

      editor.addEventListener("click", async (e) => {
        const act = e.target.dataset.act;
        if (act !== "upload-logo") return;

        const i = +e.target.dataset.i;
        const key = document.querySelector("#adminKey").value || "";
        const file = pickedFiles[i];

        if (!file) {
          status.textContent = "Pilih file dulu.";
          return;
        }
        if (!["image/png", "image/jpeg", "image/svg+xml"].includes(file.type)) {
          status.textContent = "Tipe file harus PNG atau JPG atau SVG.";
          return;
        }
        if (file.size > 2 * 1024 * 1024) {
          status.textContent = "File terlalu besar lebih dari 2MB.";
          return;
        }

        try {
          status.textContent = "Uploading logo...";
          const contentBase64 = await toBase64(file);

          const res = await fetch("/api/upload-logo", {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "x-admin-key": key,
            },
            body: JSON.stringify({
              filename: file.name,
              mime: file.type,
              contentBase64,
            }),
          });

          const json = await res.json();
          if (!res.ok) {
            status.textContent =
              "Upload gagal: " + (json.message || res.statusText);
            return;
          }

          // simpan url publik dari Vercel Blob
          state.products[i].logo = json.url;
          state.updatedAt = new Date().toISOString();

          const logoInput = document.querySelector(
            `input[data-k="logo"][data-i="${i}"]`
          );
          if (logoInput) {
            logoInput.value = json.url;
            logoInput.readOnly = true;
            logoInput.classList.add("bg-light");
          }

          status.textContent = "Upload sukses ✓ → " + json.url;
        } catch (err) {
          status.textContent = "Upload error: " + err.message;
        }
      });
    </script>
  </body>
</html>
